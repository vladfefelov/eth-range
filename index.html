<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Анализ Ethereum</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; padding: 20px; }
        button { padding: 10px 20px; font-size: 16px; cursor: pointer; margin-top: 10px; }
        #range { margin-top: 20px; font-size: 18px; }
        #chart-container { width: 100%; min-height: 300px; }
        canvas { width: 100% !important; height: 300px !important; }
    </style>
</head>
<body>

    <h1>Анализ Ethereum</h1>
    <button onclick="getPriceRange()">Обновить данные</button>
    <p id="range">Нажмите кнопку для обновления.</p>
    <div id="chart-container">
        <canvas id="priceChart"></canvas>
    </div>

    <script>
        let chart;

        async function getPriceRange() {
            try {
                const response = await fetch("https://api.binance.com/api/v3/klines?symbol=ETHUSDT&interval=1d&limit=50");
                const data = await response.json();

                let closingPrices = data.map(item => parseFloat(item[4])); // Цены закрытия
                let dates = data.map(item => new Date(item[0]).toLocaleDateString());

                let currentPrice = closingPrices[closingPrices.length - 1]; // Текущая цена

                // Вычисляем SMA (20-дневную скользящую среднюю)
                let sma = closingPrices.slice(-20).reduce((sum, price) => sum + price, 0) / 20;

                // Вычисляем стандартное отклонение
                let variance = closingPrices.slice(-20).reduce((sum, price) => sum + Math.pow(price - sma, 2), 0) / 20;
                let stdDev = Math.sqrt(variance);

                // Bollinger Bands
                let upperBand = (sma + 2 * stdDev).toFixed(2);
                let lowerBand = (sma - 2 * stdDev).toFixed(2);

                // ATR (волатильность)
                let atrValues = [];
                for (let i = 1; i < closingPrices.length; i++) {
                    atrValues.push(Math.abs(closingPrices[i] - closingPrices[i - 1]));
                }
                let atr = atrValues.slice(-20).reduce((sum, val) => sum + val, 0) / 20;
                let atrLower = (currentPrice - atr).toFixed(2);
                let atrUpper = (currentPrice + atr).toFixed(2);

                // Определяем уровни поддержки и сопротивления
                let support = Math.min(...closingPrices.slice(-20)).toFixed(2);
                let resistance = Math.max(...closingPrices.slice(-20)).toFixed(2);

                // Итоговый диапазон
                let finalLower = Math.max(lowerBand, atrLower, support);
                let finalUpper = Math.min(upperBand, atrUpper, resistance);

                document.getElementById("range").innerText = `Диапазон: ${finalLower} - ${finalUpper} USDT`;

                drawChart(dates, closingPrices, finalLower, finalUpper);

            } catch (error) {
                document.getElementById("range").innerText = "Ошибка при получении данных.";
            }
        }

        function drawChart(dates, prices, lower, upper) {
            if (chart) chart.destroy();

            let ctx = document.getElementById('priceChart').getContext('2d');
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [
                        {
                            label: 'Цена закрытия (ETH)',
                            data: prices,
                            borderColor: 'blue',
                            fill: false
                        },
                        {
                            label: 'Верхняя граница диапазона',
                            data: Array(prices.length).fill(upper),
                            borderColor: 'red',
                            borderDash: [5, 5],
                            fill: false
                        },
                        {
                            label: 'Нижняя граница диапазона',
                            data: Array(prices.length).fill(lower),
                            borderColor: 'green',
                            borderDash: [5, 5],
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { title: { display: true, text: 'Дата' } },
                        y: { title: { display: true, text: 'Цена (USDT)' } }
                    }
                }
            });
        }
    </script>

</body>
</html>