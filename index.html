<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Грид-бот для ETH/USDT (агрессивная стратегия)</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/luxon"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      margin: 20px;
    }
    #chart-container {
      width: 90%;
      max-width: 900px;
      height: 450px;
      margin: 20px auto;
    }
    canvas {
      background: #f8f8f8;
      border: 1px solid #ccc;
      border-radius: 8px;
    }
    button {
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
      margin: 10px;
    }
    #result {
      font-size: 16px;
      margin-bottom: 10px;
      text-align: left;
      max-width: 900px;
      margin-left: auto;
      margin-right: auto;
    }
  </style>
</head>
<body>
  <h1>Грид-бот для ETH/USDT (агрессивная стратегия)</h1>
  <button onclick="calculateRange()">Рассчитать</button>
  <p id="result"></p>
  <div id="chart-container">
    <canvas id="priceChart"></canvas>
  </div>

  <script>
    function calcEMA(prices, period) {
      if (prices.length < period) return [];
      const k = 2 / (period + 1);
      let ema = [];
      let sma = prices.slice(0, period).reduce((a, b) => a + b, 0) / period;
      ema.push(sma);
      for (let i = period; i < prices.length; i++) {
        sma = prices[i] * k + sma * (1 - k);
        ema.push(sma);
      }
      return ema;
    }

    function calcMACD(prices, shortPeriod = 6, longPeriod = 12, signalPeriod = 9) {
      if (prices.length < longPeriod) return { macd: 0, signal: 0 };
      const emaShort = calcEMA(prices, shortPeriod).slice(longPeriod - shortPeriod);
      const emaLong = calcEMA(prices, longPeriod);
      const macdSeries = emaShort.map((val, i) => val - emaLong[i]);
      const signalLine = calcEMA(macdSeries, signalPeriod);
      return {
        macd: macdSeries[macdSeries.length - 1],
        signal: signalLine[signalLine.length - 1] || 0,
      };
    }

    function calcRSI(prices, period = 9) {
      if (prices.length < period + 1) return 50;
      let gains = 0, losses = 0;
      for (let i = 1; i <= period; i++) {
        let diff = prices[i] - prices[i - 1];
        if (diff > 0) gains += diff;
        else losses -= diff;
      }
      gains /= period;
      losses /= period;
      if (losses === 0) return 100;
      const rs = gains / losses;
      return 100 - (100 / (1 + rs));
    }

    function calcATR(highs, lows, closes, period = 9) {
      if (highs.length < period + 1) return NaN;
      let trValues = highs.slice(1).map((h, i) =>
        Math.max(h - lows[i + 1], Math.abs(h - closes[i]), Math.abs(lows[i + 1] - closes[i]))
      );
      return calcEMA(trValues, period).pop();
    }

    async function calculateRange() {
      const symbol = "ETHUSDT";
      const interval = "5m";
      const limit = 200;
      try {
        const response = await fetch(`https://api.binance.com/api/v3/klines?symbol=${symbol}&interval=${interval}&limit=${limit}`);
        if (!response.ok) throw new Error("Ошибка загрузки данных Binance API");
        const data = await response.json();
        if (!Array.isArray(data) || data.length === 0) throw new Error("Пустой ответ API");

        const prices = data.map(d => parseFloat(d[4]));
        const highs = data.map(d => parseFloat(d[2]));
        const lows = data.map(d => parseFloat(d[3]));
        const closes = prices;

        const currentPrice = prices[prices.length - 1];
        const support = Math.min(...lows.slice(-50));
        const resistance = Math.max(...highs.slice(-50));
        const rsi = calcRSI(prices, 9);
        const macd = calcMACD(prices, 6, 12);
        const atr = calcATR(highs, lows, closes, 9);

        let direction = "Нейтральный";
        if (rsi > 70 && macd.macd > macd.signal) direction = "Лонг";
        else if (rsi < 30 && macd.macd < macd.signal) direction = "Шорт";

        document.getElementById("result").innerHTML = `
          <strong>Текущая цена:</strong> ${currentPrice.toFixed(2)} USDT<br>
          <strong>Поддержка:</strong> ${support.toFixed(2)} USDT<br>
          <strong>Сопротивление:</strong> ${resistance.toFixed(2)} USDT<br>
          <strong>RSI:</strong> ${rsi.toFixed(2)}<br>
          <strong>MACD:</strong> ${macd.macd.toFixed(2)}<br>
          <strong>Сигнальная линия MACD:</strong> ${macd.signal.toFixed(2)}<br>
          <strong>ATR:</strong> ${atr.toFixed(2)}<br>
          <strong>Направление:</strong> ${direction}
        `;
      } catch (error) {
        console.error(error);
        document.getElementById("result").innerText = "Ошибка загрузки данных.";
      }
    }
  </script>
</body>
</html>
