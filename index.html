<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Краткосрочный прогноз диапазона для грид‑бота (Ethereum)</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
      body { font-family: Arial, sans-serif; text-align: center; padding: 20px; }
      button { padding: 10px 20px; font-size: 16px; cursor: pointer; margin-top: 10px; }
      #range { margin-top: 20px; font-size: 18px; }
      #chart-container { width: 100%; min-height: 300px; }
      canvas { width: 100% !important; height: 300px !important; }
      #gridInfo { margin-top: 10px; font-size: 16px; }
  </style>
</head>
<body>
  <h1>Краткосрочный прогноз диапазона для грид‑бота (Ethereum)</h1>
  <button onclick="getPriceRange()">Обновить данные</button>
  <p id="range">Нажмите кнопку для обновления.</p>
  <p id="gridInfo"></p>
  <div id="chart-container">
      <canvas id="priceChart"></canvas>
  </div>

  <script>
    let chart;

    // Функция для вычисления медианы из трёх чисел
    function median(a, b, c) {
      return a + b + c - Math.min(a, b, c) - Math.max(a, b, c);
    }

    async function getPriceRange() {
      try {
          // Запрашиваем данные за последние 50 дней для стабильности вычислений и графика
          const response = await fetch("https://api.binance.com/api/v3/klines?symbol=ETHUSDT&interval=1d&limit=50");
          const data = await response.json();

          // Извлекаем цены закрытия и даты
          let closingPrices = data.map(item => parseFloat(item[4])); // [4] — цена закрытия
          let dates = data.map(item => new Date(item[0]).toLocaleDateString());

          // Для расчёта диапазона используем последние 10 дней
          let recentData = closingPrices.slice(-10);
          let currentPrice = closingPrices[closingPrices.length - 1];

          // 1. Bollinger Bands (10-дневная SMA и стандартное отклонение)
          let sma = recentData.reduce((sum, price) => sum + price, 0) / recentData.length;
          let variance = recentData.reduce((sum, price) => sum + Math.pow(price - sma, 2), 0) / recentData.length;
          let stdDev = Math.sqrt(variance);
          let lowerBand = sma - 2 * stdDev;
          let upperBand = sma + 2 * stdDev;

          // 2. ATR (расчёт для последних 10 дней)
          let atrValues = [];
          for (let i = closingPrices.length - recentData.length + 1; i < closingPrices.length; i++) {
              atrValues.push(Math.abs(closingPrices[i] - closingPrices[i - 1]));
          }
          let atr = atrValues.reduce((sum, value) => sum + value, 0) / atrValues.length;
          let atrLower = currentPrice - atr;
          let atrUpper = currentPrice + atr;

          // 3. Уровни поддержки и сопротивления (минимум и максимум за последние 10 дней)
          let support = Math.min(...recentData);
          let resistance = Math.max(...recentData);

          // Итоговый диапазон – медиана из значений каждого метода для нижней и верхней границы
          let finalLower = median(lowerBand, atrLower, support);
          let finalUpper = median(upperBand, atrUpper, resistance);

          document.getElementById("range").innerText = 
              `Диапазон: ${finalLower.toFixed(2)} - ${finalUpper.toFixed(2)} USDT`;

          // Расчёт параметров для грид‑бота:
          // Для максимального количества сеток (цель: 50-70 тыс сделок за пару дней) предлагается очень мелкий шаг.
          // Здесь выбираем количество сеток равным 1000, то есть шаг = (finalUpper - finalLower) / 1000.
          let finalRange = finalUpper - finalLower;
          let targetGridCount = 1000; // можно корректировать для достижения нужной частоты сделок
          let gridStep = finalRange / targetGridCount;
          
          document.getElementById("gridInfo").innerText = 
              `Предлагаемое количество сеток: ${targetGridCount}, Шаг сетки: ${gridStep.toFixed(4)} USDT`;

          // Для графика отображаются только последние 3 дня
          const chartLimit = 3;
          let chartDates = dates.slice(-chartLimit);
          let chartPrices = closingPrices.slice(-chartLimit);
          // Линии диапазона для последних 3 дней
          let rangeLowerArray = Array(chartLimit).fill(finalLower.toFixed(2));
          let rangeUpperArray = Array(chartLimit).fill(finalUpper.toFixed(2));

          drawChart(chartDates, chartPrices, rangeLowerArray, rangeUpperArray);

      } catch (error) {
          document.getElementById("range").innerText = "Ошибка при получении данных.";
          document.getElementById("gridInfo").innerText = "";
      }
    }

    function drawChart(dates, prices, lowerArray, upperArray) {
      if (chart) chart.destroy();

      let ctx = document.getElementById('priceChart').getContext('2d');
      chart = new Chart(ctx, {
          type: 'line',
          data: {
              labels: dates,
              datasets: [
                  {
                      label: 'Цена закрытия (ETH)',
                      data: prices,
                      borderColor: 'blue',
                      fill: false
                  },
                  {
                      label: 'Верхняя граница диапазона',
                      data: upperArray,
                      borderColor: 'red',
                      borderDash: [5, 5],
                      fill: false
                  },
                  {
                      label: 'Нижняя граница диапазона',
                      data: lowerArray,
                      borderColor: 'green',
                      borderDash: [5, 5],
                      fill: false
                  }
              ]
          },
          options: {
              responsive: true,
              maintainAspectRatio: false,
              scales: {
                  x: { title: { display: true, text: 'Дата' } },
                  y: { title: { display: true, text: 'Цена (USDT)' } }
              }
          }
      });
    }
  </script>

</body>
</html>